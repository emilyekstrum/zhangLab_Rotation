---
title: "mouse_LR_filtering.Rmd"
author: "Emily Ekstrum"
date: "`r Sys.Date()`"
output: html_document

params:
  
  # cell chat input must be gene by cell matrices
  mouse_hvg: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/hvgs/mouse_hvg_gene_cell_matrix.rds"
  mouse_nnsvg:  "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_mouse_svg_gene_cell_matrix.rds"
  mouse_seurat_svg:  "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/seurat_mouse_svg_gene_cell_matrix.rds"

    
  seed: 123
---

# file setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5
)
set.seed(params$seed)
```

# Ligand receptor filtering for HVGs and SVGs

# load in packages

```{r packages}
pkgs <- c(
  "Seurat",
  "Matrix",
  "ggplot2",
  "dplyr",
  "tibble",
  "patchwork",
  "umap",
  "CellChat"
)

to_install <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(to_install) > 0) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

# Load
lapply(pkgs, library, character.only = TRUE)
```


```{r}
# load in mouse data
mouse_hvg <- readRDS(params$mouse_hvg)
mouse_nnsvg <- readRDS(params$mouse_nnsvg)
mouse_seurat_svg <- readRDS(params$mouse_seurat_svg)

# make sure they are gene by cell 
head(mouse_hvg)
head(mouse_nnsvg)
head(mouse_seurat_svg)
```

```{r}
# find percent similarity of genes in hvgs and svgs
hvg_genes <- rownames(mouse_hvg)
nnsvg_genes <- rownames(mouse_nnsvg)
seurat_svg_genes <- rownames(mouse_seurat_svg)
length(intersect(hvg_genes, nnsvg_genes)) / length(union(hvg_genes, nnsvg_genes))
length(intersect(hvg_genes, seurat_svg_genes)) / length(union(hvg_genes, seurat_svg_genes))
length(intersect(nnsvg_genes, seurat_svg_genes)) / length(union(nnsvg_genes, seurat_svg_genes))
```


# ----------------- nanxi's code -------------------- #

```{r}

CellChatDB <- CellChatDB.mouse
showDatabaseCategory(CellChatDB)
```


```{r}
# LR table
db_interactions <- CellChatDB$interaction
dplyr::glimpse(db_interactions)
```

```{r}
# use only a subset, e.g., secreted signaling
CellChatDB.use <- subsetDB(CellChatDB, search = "Secreted Signaling")
```

```{r}
dplyr::glimpse(CellChatDB$interaction)
```

```{r}
# use all CellChatDB except for "Non-protein Signaling" for cell-cell communication analysis
CellChatDB.use <- subsetDB(CellChatDB)

```

```{r}
dplyr::glimpse(CellChatDB.use$interaction)

```

```{r}
# LR table
# use all CellChatDB except for "Non-protein Signaling" for cell-cell communication analysis
db_interactions_use <- CellChatDB.use$interaction
```

Get LR definitions that the Visium mouse brain can support

# HVGs
```{r}
# genes present in the expression matrix 
hvg_genes_in_data <- rownames(mouse_hvg)
head(hvg_genes_in_data)

# Keep LR entries whose all ligand and receptor subunits exist in the data.

hvg_lr_present <- db_interactions_use |>
  rowwise() |>
  filter(all(unlist(strsplit(ligand, "\\|")) %in% hvg_genes_in_data) &
           all(unlist(strsplit(receptor, "\\|")) %in% hvg_genes_in_data)) |>
  ungroup()
```

```{r}
nrow(hvg_lr_present)
head(hvg_lr_present)
```


# SVGs
# using nnSVG

```{r}
# genes present in the expression matrix
svg_genes_in_data <- rownames(mouse_nnsvg)
head(svg_genes_in_data)

# Keep LR entries whose all ligand and receptor subunits exist in the data.

svg_lr_present <- db_interactions_use |>
  rowwise() |>
  filter(all(unlist(strsplit(ligand, "\\|")) %in% svg_genes_in_data) &
           all(unlist(strsplit(receptor, "\\|")) %in% svg_genes_in_data)) |>
  ungroup()
```

```{r}
nrow(svg_lr_present)
head(svg_lr_present)
```


```{r}
# find differences in interaction names between hvgs and svgs
hvg_interactions <- hvg_lr_present$interaction_name
svg_interactions <- svg_lr_present$interaction_name
length(intersect(hvg_interactions, svg_interactions)) / length(union(hvg_interactions, svg_interactions))
```

The LR interactions are similar for the mouse dataset.

```{r}
# save lr present tables
saveRDS(hvg_lr_present, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/LR_filtering/mouse_hvg_lr_present.rds")
saveRDS(svg_lr_present, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/LR_filtering/mouse_svg_lr_present.rds")
```