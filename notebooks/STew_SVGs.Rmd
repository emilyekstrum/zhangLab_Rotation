---
title: "nnSVG_workaround"
author: "Emily Ekstrum"
date: "`r Sys.Date()`"
output: html_document

params:
  mouse_rds_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/mousebrain_seurat.rds"
  human_rds_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/humanbrain_seurat.rds"
  seed: 123

---


```{r}
# set up to limit threads for BLAS/LAPACK operations
## Must be set before loading Matrix / nnSVG / BRISC / Seurat
Sys.setenv(
  OMP_NUM_THREADS = "1",
  OPENBLAS_NUM_THREADS = "1",
  MKL_NUM_THREADS = "1",
  VECLIB_MAXIMUM_THREADS = "1",
  NUMEXPR_NUM_THREADS = "1"
)

#  helps (limits BLAS threads if you have RhpcBLASctl)
if (requireNamespace("RhpcBLASctl", quietly = TRUE)) {
  RhpcBLASctl::blas_set_num_threads(1)
  RhpcBLASctl::omp_set_num_threads(1)
}

```

```{r}
library(BiocParallel)
library(nnSVG)

bp <- SnowParam(workers = 3, type = "SOCK")  # safe parallel on macOS
# OR, if you just want maximum stability:
# bp <- SerialParam()
```


# -------------- mouse data ------------------ # 

```{r}
# load in mouse seurat object
mouse_seurat <- readRDS(params$mouse_rds_path)
```

```{r}
library(Seurat)
library(Matrix)
library(BRISC)

# extract expression as a real sparse matrix
mouse_exp_mat <- LayerData(mouse_seurat, assay = "RNA", layer = "counts")

# force dgCMatrix 
mouse_exp_mat <- as(mouse_exp_mat, "dgCMatrix")

# coords with rownames = cell barcodes
mouse_coords <- mouse_seurat@meta.data[, c("imagecol", "imagerow"), drop = FALSE]
stopifnot(!is.null(rownames(mouse_coords)))
mouse_coords <- as.matrix(mouse_coords)
storage.mode(mouse_coords) <- "double"

# align cells
mouse_common <- intersect(colnames(mouse_exp_mat), rownames(mouse_coords))
stopifnot(length(mouse_common) > 0)
mouse_exp_mat <- mouse_exp_mat[, mouse_common, drop = FALSE]
mouse_coords <- mouse_coords[mouse_common, , drop = FALSE]

# keep genes that are expressed in at least 10 spots
mouse_keep <- Matrix::rowSums(mouse_exp_mat > 0) >= 10  # can edit to make more strict
mouse_exp_mat <- mouse_exp_mat[mouse_keep, , drop = FALSE]

# cap to 3000 most variable genes using sparse variance proxy
mouse_gene_vars <- Matrix::rowMeans(mouse_exp_mat^2) - (Matrix::rowMeans(mouse_exp_mat))^2
mouse_top <- names(sort(mouse_gene_vars, decreasing = TRUE))[1:min(5000, length(mouse_gene_vars))]
mouse_exp_mat <- mouse_exp_mat[mouse_top, , drop = FALSE]

# check you have dgCMatrix
#class(mouse_exp_mat)
#is(mouse_exp_mat, "dgCMatrix")

```

```{r}
# run nnSVG to find spatially variable genes
mouse_svgs <- nnSVG(input = mouse_exp_mat, spatial_coords = mouse_coords, BPPARAM = bp)
```

```{r}
library(tidyverse)

# create svg dataframe
mouse_svgs <- as.data.frame(mouse_svgs)

# subset the genes where padj < 0.05
mouse_auto_genes_list <- mouse_svgs %>%
  filter(padj < 0.1) %>%
  rownames()

head(mouse_auto_genes_list)
head(mouse_svgs) # LR stat is log likelihood ratio
```

```{r}
# create results data frame
mouse_res <- as.data.frame(mouse_svgs)
mouse_res$gene <- rownames(mouse_res)

# keep finite padj
mouse_res <- mouse_res[is.finite(mouse_res$padj) & !is.na(mouse_res$padj), ]
mouse_res$neglog10_padj <- -log10(pmax(mouse_res$padj, 1e-300))

# look at top results
head(mouse_res[, c("gene","LR_stat","pval","padj","rank")])

```

```{r}
# save res data frame
saveRDS(mouse_res, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/nnSVG_mouse_results.rds")
```

```{r}
# volcano plot: rank vs -log10(padj)
ggplot(mouse_res, aes(x = rank, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "Rank (1 = most significant)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# volcano plot: log likelihood vs -log10(padj)
ggplot(mouse_res, aes(x = LR_stat, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "LR_stat",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# p value dist
ggplot(mouse_res, aes(x = padj)) +
  geom_histogram(bins = 50) +
  labs(title = "Adjusted p-value distribution", x = "padj", y = "Count") +
  theme_classic()

```

```{r}
library(Seurat)
library(Matrix)
library(patchwork)

# pick top genes by padj
top_n <- 6
mouse_top_genes <- head(mouse_res$gene[order(mouse_res$padj)], top_n)

#filter out MT genes and get top genes again
mouse_top_genes <- mouse_res %>%
  filter(!grepl("^MT-|mt-", gene)) %>%
  arrange(padj) %>%
  slice_head(n = top_n) %>%
  pull(gene)

# coords with barcodes as rownames
mouse_coords <- mouse_seurat@meta.data[, c("imagecol","imagerow"), drop = FALSE]
mouse_coords$cell <- rownames(mouse_coords)

# helper to plot one gene
plot_svg_gene <- function(g) {
  if (!g %in% rownames(mouse_exp_mat)) stop(paste("Gene not found in matrix:", g))
  df <- mouse_coords
  df$expr <- as.numeric(mouse_exp_mat[g, df$cell])

  ggplot(df, aes(x = imagecol, y = imagerow, color = expr)) +
    geom_point(size = 0.8) +
    scale_y_reverse() +    
    xlab("x") +
    ylab("y") +
    coord_equal() +
    labs(title = g, color = "Expr") +
    theme_classic()
}

plots <- lapply(mouse_top_genes, plot_svg_gene)
wrap_plots(plots, ncol = 3)

```

```{r}
# scatter plot: prop_sv vs -log10(padj)
ggplot(mouse_res, aes(x = prop_sv, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  labs(title = "prop_sv vs significance", x = "prop_sv", y = "-log10(padj)") +
  theme_classic()

```


# -------------- human data ------------------ # 

```{r}
human_seurat <- readRDS(params$human_rds_path)
```

```{r}
# extract expression as a real sparse matrix
human_exp_mat <- LayerData(human_seurat, assay = "RNA", layer = "counts")

# force dgCMatrix 
human_exp_mat <- as(human_exp_mat, "dgCMatrix")

# coords with rownames = cell barcodes
human_coords <- human_seurat@meta.data[, c("imagecol", "imagerow"), drop = FALSE]
stopifnot(!is.null(rownames(human_coords)))
human_coords <- as.matrix(human_coords)
storage.mode(human_coords) <- "double"

# align cells
human_common <- intersect(colnames(human_exp_mat), rownames(human_coords))
stopifnot(length(human_common) > 0)
human_exp_mat <- human_exp_mat[, human_common, drop = FALSE]
human_coords <- human_coords[human_common, , drop = FALSE]

# keep genes that are expressed in at least 10 spots
human_keep <- Matrix::rowSums(human_exp_mat > 0) >= 10  # can edit to make more strict
human_exp_mat <- human_exp_mat[human_keep, , drop = FALSE]

# cap to 3000 most variable genes using sparse variance proxy
human_gene_vars <- Matrix::rowMeans(human_exp_mat^2) - (Matrix::rowMeans(human_exp_mat))^2
human_top <- names(sort(human_gene_vars, decreasing = TRUE))[1:min(5000, length(human_gene_vars))]
human_exp_mat <- human_exp_mat[human_top, , drop = FALSE]

# check you have dgCMatrix
#class(human_exp_mat)
#is(human_exp_mat, "dgCMatrix")

```

```{r}
# run nnSVG to find spatially variable genes
human_svgs <- nnSVG(input = human_exp_mat, spatial_coords = human_coords, BPPARAM = bp)
```

```{r}
library(tidyverse)

# create svg dataframe
human_svgs <- as.data.frame(human_svgs)

# subset the genes where padj < 0.05
human_auto_genes_list <- human_svgs %>%
  filter(padj < 0.1) %>%
  rownames()

head(human_auto_genes_list)
head(human_svgs) # LR stat is log likelihood ratio
```

```{r}
# create results data frame
human_res <- as.data.frame(human_svgs)
human_res$gene <- rownames(human_res)

# keep finite padj
human_res <- human_res[is.finite(human_res$padj) & !is.na(human_res$padj), ]
human_res$neglog10_padj <- -log10(pmax(human_res$padj, 1e-300))

# look at top results
# TODO: filter out MT genes?
head(human_res[, c("gene","LR_stat","pval","padj","rank")])
```

```{r}
# save res data frame
saveRDS(human_res, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/nnSVG_human_results.rds")
```

```{r}
# volcano plot: rank vs -log10(padj)
ggplot(human_res, aes(x = rank, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "Rank (1 = most significant)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# volcano plot: log likelihood vs -log10(padj)
ggplot(human_res, aes(x = LR_stat, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "LR_stat",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# p value dist
ggplot(human_res, aes(x = padj)) +
  geom_histogram(bins = 50) +
  labs(title = "Adjusted p-value distribution", x = "padj", y = "Count") +
  theme_classic()

```

```{r}
library(Seurat)
library(Matrix)
library(patchwork)

# pick top genes by padj
human_top_n <- 6
human_top_genes <- head(human_res$gene[order(human_res$padj)], human_top_n)

#filter out MT genes and get top genes again
human_top_genes <- human_res %>%
  filter(!grepl("^MT-", gene)) %>%
  arrange(padj) %>%
  slice_head(n = top_n) %>%
  pull(gene)

# coords with barcodes as rownames
human_coords <- human_seurat@meta.data[, c("imagecol","imagerow"), drop = FALSE]
human_coords$cell <- rownames(human_coords)

# helper to plot one gene
plot_svg_gene <- function(g) {
  if (!g %in% rownames(exp_mat)) stop(paste("Gene not found in matrix:", g))
  df <- coords
  df$expr <- as.numeric(exp_mat[g, df$cell])

  ggplot(df, aes(x = imagecol, y = imagerow, color = expr)) +
    geom_point(size = 0.8) +
    scale_y_reverse() +
    xlab("x") +
    ylab("y") +
    coord_equal() +
    labs(title = g, color = "Expr") +
    theme_classic()
}

plots <- lapply(human_top_genes, plot_svg_gene)
wrap_plots(plots, ncol = 3)

```

```{r}
# scatter plot: prop_sv vs -log10(padj)
ggplot(human_res, aes(x = prop_sv, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  labs(title = "prop_sv vs significance", x = "prop_sv", y = "-log10(padj)") +
  theme_classic()

```
