---
title: "Human Brain (DLPFC) 10x EDA & Seurat"
author: "Emily Ekstrum"
date: ""
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
params:
  # gene expression
  h5_path: "/Users/emilyekstrum/Desktop/zhangLab/data/DLPFC_Data/Sample151673/151673_filtered_feature_bc_matrix.h5"

  # spatial coordinates
  spatial_csv: "/Users/emilyekstrum/Desktop/zhangLab/data/DLPFC_Data/Sample151673/DLPFC_spatial_3639cells_2cols.csv"

  # manual annotations
  annotation_csv: "/Users/emilyekstrum/Desktop/zhangLab/data/DLPFC_Data/Sample151673/Manual_annotation_3639cells.csv"

  # for seurat object
  assay_name: "RNA"
  min_cells: 3
  min_features: 200

  # filtering params
  filter: true
  nFeature_low: 200
  nFeature_high: 7500
  nCount_high: 60000
  mt_prefix: "^(mt-|MT-)"
  percent_mt_high: 20

  # dim reduction params
  n_pcs: 30
  clustering_resolution: 0.5
  seed: 123
---

# file setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5
)
set.seed(params$seed)

`%||%` <- function(a, b) if (!is.null(a)) a else b
```

# Human Brain EDA & Seurat Analysis

1. Loads in 10x visium human brain spatial transcriptomics data from H5 file
    - spans 6 neuronal layers + white matter
2. merges spatial coordinates and manual annotations into `meta.data`
3. EDA/QC: library size, detected genes, mitochondrial fraction
4. Saves seurat object as RDA file

**Inputs**
- Counts: `r params$h5_path`
- Spatial coords: `r params$spatial_csv`
- Manual annotations: `r params$annotation_csv`

# load in packages

```{r packages}
pkgs <- c("Seurat",
          "Matrix",
          "ggplot2",
          "dplyr",
          "tibble",
          "patchwork",
          "readr", 
          "hdf5r")

to_install <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(to_install) > 0) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

lapply(pkgs, library, character.only = TRUE)
```

# Load counts from 10x H5
```{r load-h5}
h5_path <- params$h5_path
stopifnot(file.exists(h5_path))

counts <- Read10X_h5(h5_path)

# handle a matrix or a named list of matrices 
if (is.list(counts)) {
  message("Read10X_h5 returned a list with names: ", paste(names(counts), collapse = ", "))
  # get the gene expression matrix
  key <- intersect(names(counts), c("Gene Expression","RNA","gene_expression","GeneExpression"))
  if (length(key) == 0) key <- names(counts)[1]
  counts <- counts[[key[1]]]
}

# 
stopifnot(inherits(counts, c("dgCMatrix","matrix")))
dim(counts) # genes x cells
```

Counts matrix with 33,538 genes and 3,639 cells 

# Load in metadata (spatial coords + manual annotations)
merges metadata by cell barcode 

```{r load-meta}
load_csv_if_exists <- function(path) {
  if (is.null(path) || path == "" || is.na(path) || !file.exists(path)) return(NULL)
  df <- readr::read_csv(path, show_col_types = FALSE)
  as.data.frame(df)
}

spatial_df <- load_csv_if_exists(params$spatial_csv)
annot_df   <- load_csv_if_exists(params$annotation_csv)

if (!is.null(spatial_df)) {
  message("Loaded spatial CSV with dim: ", paste(dim(spatial_df), collapse=" x "))
  print(head(spatial_df, 3))
} else {
  message("No spatial CSV loaded (file missing or params$spatial_csv is blank).")
}

if (!is.null(annot_df)) {
  message("Loaded annotation CSV with dim: ", paste(dim(annot_df), collapse=" x "))
  print(head(annot_df, 3))
} else {
  message("No annotation CSV loaded (file missing or params$annotation_csv is blank).")
}
```



## Merge helper
```{r merge-helper}
guess_barcode_col <- function(df) {
  if (is.null(df)) return(NULL)
  nms <- tolower(names(df))
  candidates <- c("barcode","barcodes","cell","cell_id","cellid","spot","spot_id","id")
  hit <- candidates[candidates %in% nms]
  if (length(hit) > 0) return(names(df)[match(hit[1], nms)])
  NULL
}

merge_meta <- function(meta, df, cells) {
  if (is.null(df)) return(meta)

  bc_col <- guess_barcode_col(df)

  if (!is.null(bc_col)) {
    df[[bc_col]] <- as.character(df[[bc_col]])
    rownames(df) <- df[[bc_col]]
    df[[bc_col]] <- NULL
    df2 <- df[intersect(rownames(df), cells), , drop = FALSE]
    meta[rownames(df2), names(df2)] <- df2
    return(meta)
  }

  if (nrow(df) == length(cells)) {
    rownames(df) <- cells
    meta[cells, names(df)] <- df
    return(meta)
  }

  warning("Could not merge metadata: no obvious barcode column and row count did not match cell count.")
  return(meta)
}
```


# Create Seurat object
```{r create-seurat}
cells <- colnames(counts)
meta <- data.frame(row.names = cells)

meta <- merge_meta(meta, spatial_df, cells)
meta <- merge_meta(meta, annot_df,   cells)

human_seurat <- CreateSeuratObject(
  counts = counts,
  assay = params$assay_name,
  min.cells = params$min_cells,
  min.features = params$min_features,
  meta.data = meta
)

# add mitochondrial percentage
mt_features <- grep(params$mt_prefix, rownames(human_seurat), value = TRUE)

if (length(mt_features) > 0) {
  human_seurat[["percent.mt"]] <- PercentageFeatureSet(human_seurat, features = mt_features)
} else {
  warning(paste0(
    "No mitochondrial genes matched params$mt_prefix = '", params$mt_prefix,
    "'. percent.mt will not be computed."
  ))
}

human_seurat
```

# EDA and QC

```{r qc-basic}
features_to_plot <- c("nFeature_RNA", "nCount_RNA", "percent.mt")
VlnPlot(human_seurat, features = features_to_plot, ncol = length(features_to_plot), pt.size = 0.1)
```
nFeature_RNA: Number of detected genes per spot
  - Even spread of genes detected per spot
nCount_RNA: Total UMI (unique molecular identifiers) counts/reads per spot
percent.mt: Percentage of mitochondrial gene expression per spot (if mitochondrial genes were found)
  - Most spots have low mitochondrial percentage (< 20%), indicating good data

```{r qc-scatter}
FeatureScatter(human_seurat, "nCount_RNA", "nFeature_RNA")
FeatureScatter(human_seurat, "nCount_RNA", "percent.mt")
FeatureScatter(human_seurat, "nFeature_RNA", "percent.mt")
```
nCount_RNA vs nFeature_RNA: Positive correlation & tight monotonic relationship (r 0.99)
  - spots with higher counts tend to have more detected genes.
nCount_RNA vs percent.mt: No strong correlation (r -0.09)
  - spots with high counts do not necessarily have high mitochondrial percentage
nFeature_RNA vs percent.mt: No strong correlation (r -0.16)
  - spots with more detected genes do not necessarily have high mitochondrial percentage


# Spatial dist of mt percentage
```{r}
# plot spatial distribution of mitochondrial percentage
ggplot(human_seurat@meta.data, aes(x = imagecol, y = imagerow, color = percent.mt)) +
  geom_point(size = 0.6) +
  coord_fixed() +
  scale_y_reverse() +
  theme_classic()
```
No strong spatial pattern of mitochondrial percentage across the tissue section, indicating no localized regions of high mitochondrial content

# filtering
```{r}
# print filtering params used
if (isTRUE(params$filter)) {
  message("Filtering enabled with thresholds:")
  print(list(
    nFeature_low = params$nFeature_low,
    nFeature_high = params$nFeature_high,
    nCount_high = params$nCount_high,
    percent_mt_high = params$percent_mt_high
  ))

  # filter spots based on QC metrics
expr <- human_seurat@meta.data$nFeature_RNA >= params$nFeature_low &
        human_seurat@meta.data$nFeature_RNA <= params$nFeature_high &
        human_seurat@meta.data$nCount_RNA <= params$nCount_high &
        human_seurat@meta.data$percent.mt <= params$percent_mt_high

  if ("percent.mt" %in% colnames(human_seurat@meta.data)) {
    expr <- expr & (human_seurat@meta.data$percent.mt <= params$percent_mt_high)
  }

  human_seurat <- subset(human_seurat, cells = rownames(human_seurat@meta.data)[expr])
}

# Check for NA/NaN/Inf values in count matrix
counts_mat <- GetAssayData(human_seurat, assay = "RNA", layer = "counts")

bad <- is.na(counts_mat) | is.infinite(counts_mat)
if (any(bad)) {
  warning("Found NA/Inf in count matrix. Replacing with 0.")
  counts_mat[bad] <- 0
  human_seurat <- SetAssayData(human_seurat, assay = "RNA", layer = "counts", new.data = counts_mat)
}


# Remove spots with zero total counts (can cause log_umi issues)
zero_count_spots <- which(human_seurat$nCount_RNA == 0)
if (length(zero_count_spots) > 0) {
  warning(paste("Removing", length(zero_count_spots), "spots with zero total counts"))
  cells_to_keep <- setdiff(colnames(human_seurat), names(zero_count_spots))
  human_seurat <- subset(human_seurat, cells = cells_to_keep)
}

# filter out low quality spots 
# human_seurat <- subset(human_seurat, subset = nFeature_RNA > 200 & nFeature_RNA < 8000 & percent.mt < 20)

# summary stats for filtering
cat("Data quality summary:\n")
cat("Number of spots:", ncol(human_seurat), "\n")
cat("Number of genes:", nrow(human_seurat), "\n")
cat("nCount_RNA range:", range(human_seurat$nCount_RNA), "\n")
cat("nFeature_RNA range:", range(human_seurat$nFeature_RNA), "\n")
cat("Percent MT range:", range(human_seurat$percent.mt), "\n")

# variance stabilizing transformation using SCTransform
human_seurat_sct <- SCTransform(human_seurat,
                          vst.flavor = "v2",
                          variable.features.n = 10000,
                          vars.to.regress = c("percent.mt"),
                          return.only.var.genes = FALSE,
                          verbose = FALSE)

human_seurat_sct
```

#nCount_RNA after filtering & SCTransform
```{r}
# nCount_RNA from counts matrix
counts_mat <- GetAssayData(human_seurat_sct, assay = "RNA", layer = "counts")
human_seurat_sct$nCount_RNA <- Matrix::colSums(counts_mat)
summary(human_seurat_sct$nCount_RNA)
```

Median nCount_RNA is on the lower end of typical for 10x Visium data
  - could be due to an overly aggressive filtering process



# Spatial visualization 
## Detect coordinate columns

```{r coords-detect}
meta_cols <- colnames(human_seurat_sct@meta.data)
coord_candidates <- list(
  x = c("x","imagecol","col","pxl_col_in_fullres","array_col"),
  y = c("y","imagerow","row","pxl_row_in_fullres","array_row")
)

find_first_present <- function(cands, cols) {
  hit <- cands[cands %in% cols]
  if (length(hit) == 0) return(NULL)
  hit[1]
}

xcol <- find_first_present(coord_candidates$x, meta_cols)
ycol <- find_first_present(coord_candidates$y, meta_cols)

list(xcol = xcol, ycol = ycol)
```

## Plot clusters on tissue coordinates

```{r spatial-clusters}
if (!is.null(xcol) && !is.null(ycol)) {
  df <- data.frame(human_seurat_sct@meta.data, cluster = Idents(human_seurat_sct))
  ggplot(df, aes(x = .data[[xcol]], y = .data[[ycol]])) +
    geom_point(size = 0.8) +
    coord_fixed() +
    scale_y_reverse() +
    theme_classic() +
    labs(title = "Spots in tissue coordinates", x = xcol, y = ycol)
} else {
  cat("No recognizable coordinate columns found in meta.data.\\n")
  cat("Available meta.data columns include:\\n")
  print(head(colnames(seu_sct@meta.data), 30))
}
```

## look at a specific gene in spatial coords

```{r spatial-gene}
if (!is.null(xcol) && !is.null(ycol)) {
  gene <- "MBP"  # change 
  if (gene %in% rownames(human_seurat_sct)) {
    df <- data.frame(human_seurat_sct@meta.data, expr = FetchData(human_seurat_sct, vars = gene)[,1])
    ggplot(df, aes(x = .data[[xcol]], y = .data[[ycol]], color = expr)) +
      geom_point(size = 0.8) +
      coord_fixed() +
      scale_y_reverse() +
      theme_classic() +
      labs(title = paste(gene, "expression in tissue coordinates"), x = xcol, y = ycol)
  } else {
    cat("Gene ", gene, " not found. Try another marker (e.g., SNAP25, AQP4, P2RY12, GFAP, MOBP).\\n")
  }
}
```

# dim reduction
```{r seurat-workflow}
# make SCT the default assay for downstream PCA/UMAP
DefaultAssay(human_seurat_sct) <- "SCT"
human_seurat_PCA <- RunPCA(human_seurat_sct, features = VariableFeatures(human_seurat_sct))
```

# check for batches
```{r}
table(human_seurat$orig.ident)
length(unique(human_seurat$orig.ident))
```
no batches found

```{r}
#plot PCA 
ElbowPlot(human_seurat_PCA)

DimPlot(
  human_seurat_PCA,
  reduction = "pca",
  pt.size = 0.6
) + ggtitle("PCA of spatial transcriptomics spots")
```

Elbow plot: PCs 1-5 explain most variance
PCA: Decent spread and fanning shape

```{r}
#color PCA by nFeature_RNA, nCount_RNA, percent.mt
FeaturePlot(human_seurat_PCA, reduction = "pca", features = c("nFeature_RNA", "nCount_RNA", "percent.mt"))
```

Good overlap of nFeature_RNA and nCount_RNA on PCs
No strong pattern of percent.mt on PCs
  - indicates PCs are not driven by feature, count, or mitochondrial content

```{r}
#colnames(human_seurat_PCA@meta.data)

# color PCA by spatial coordinates
x <- FeaturePlot(human_seurat_PCA, reduction = "pca", features = "imagecol")
x + ggtitle("x (image column)")
y <- FeaturePlot(human_seurat_PCA, reduction = "pca", features = "imagerow")
y + ggtitle("y (image row)")
```
No distinct patterns observed in PCA space for spatial coordinates x or y
  - indicates spatial location is not driving major sources of variation in the data

```{r}
# genes contributing to PCs
VizDimLoadings(human_seurat_PCA, dims = 1:2, reduction = "pca")
```

No obvious highly contributing genes to PCs 1 and 2

```{r}
# top genes per PC
DimHeatmap(human_seurat_PCA, dims = 1:6, cells = 500, balanced = TRUE)
```

# clustering and UMAP
```{r umap-cluster}
human_seurat_PCA <- FindNeighbors(human_seurat_PCA, dims = 1:30)
human_seurat_PCA <- FindClusters(human_seurat_PCA, resolution = params$clustering_resolution)
human_seurat_UMAP <- RunUMAP(human_seurat_PCA, dims = 1:30)

DimPlot(human_seurat_UMAP, reduction = "umap", label = TRUE) + NoLegend()
```

4 identified cell clusters with good to poor separation in UMAP space

```{r}
# plot clusters on spatial tissue coordinates
df <- data.frame(human_seurat_UMAP@meta.data, cluster = Idents(human_seurat_UMAP))

ggplot(df, aes(x = imagecol, y = imagerow, color = cluster)) +
  geom_point(size = 0.6) +
  coord_fixed() +
  scale_y_reverse() +
  theme_classic() +
  labs(
    title = "UMAP clusters projected onto human tissue coordinates",
    x = "image column",
    y = "image row"
  )
```


# Save outputs

```{r save}
out_dir <- "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)

seurat_rds <- file.path(out_dir, "humanbrain_seurat.rds")
saveRDS(human_seurat_sct, seurat_rds)

cat("Saved Seurat object to: ", seurat_rds, "\\n")

cat("Saved outputs to: ", out_dir, "\\n")
```

```{r session-info}
sessionInfo()
```
