---
title: "Mouse Brain EDA & Seurat"
author: "Emily Ekstrum"
date: "1/8/26"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    theme: "cosmo"
    df_print: paged
    
params:
  rds_path: "/Users/emilyekstrum/Desktop/zhangLab/data/MouseBrain_Data/10x_mousebrain_exp_count_meta.rds"
  assay_name: "RNA"
  min_cells: 3
  min_features: 200
  mt_prefix: "^(mt-|MT-)"
  filter: true
  nFeature_low: 200
  nFeature_high: 6000
  nCount_high: 40000
  percent_mt_high: 15
  clustering_resolution: 0.5
  seed: 123
---

# file setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5
)
set.seed(params$seed)
```

# Mouse Brain EDA & Seurat Analysis

1. Loads in rds 10x visium mouse brain spatial traonscriptomics data set
2. Exploratory data analysis (EDA) on the expression matrix and metadata
3. Creates a seurat object
4. QC, normalization, dimensionality reduction, and clustering
5. Saves outputs as RDS file

> **Input**: `r params$rds_path`

# load in packages

```{r packages}
pkgs <- c(
  "Seurat",
  "Matrix",
  "ggplot2",
  "dplyr",
  "tibble",
  "patchwork",
  "usethis",
  "credentials"
)

to_install <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(to_install) > 0) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

# Load
lapply(pkgs, library, character.only = TRUE)
```

# Load data

```{r load-data}
rds_path <- params$rds_path
stopifnot(file.exists(rds_path))

obj_raw <- readRDS(rds_path)
class(obj_raw)

print(dim(obj_raw))
print(names(obj_raw))
print(head(obj_raw[, 1:min(10, ncol(obj_raw))]))
print(table(vapply(obj_raw, function(z) class(z)[1], character(1))))
```

# Process data into counts matrix and metadata
```{r}
# specify metadata columns
meta_cols <- c("cell_id", "x", "y")

# keep only the meta columns that actually exist
meta_cols <- meta_cols[meta_cols %in% colnames(obj_raw)]

meta <- as.data.frame(obj_raw[, meta_cols, drop = FALSE])

expr_df <- obj_raw[, setdiff(colnames(obj_raw), meta_cols), drop = FALSE]
expr_df <- as.data.frame(expr_df)

# expression columns to numeric
expr_df[] <- lapply(expr_df, function(col) {
  if (is.factor(col)) col <- as.character(col)
  suppressWarnings(as.numeric(col))
})

# identify genes that could not be converted to numeric
bad <- names(expr_df)[vapply(expr_df, function(col) all(is.na(col)), logical(1))]
if (length(bad) > 0) {
  stop("These gene expression columns could not be converted to numeric: ",
       paste(bad[1:min(30, length(bad))], collapse = ", "),
       if (length(bad) > 30) " ..." else "")
}

expr_mat <- as.matrix(expr_df)
expr_mat[is.na(expr_mat)] <- 0

counts <- Matrix::Matrix(expr_mat, sparse = TRUE)
counts <- Matrix::t(counts)

# Use cell_id as the Seurat cell names if present
if ("cell_id" %in% colnames(meta)) {
  colnames(counts) <- make.unique(as.character(meta$cell_id))
  rownames(meta) <- colnames(counts)
} else {
  colnames(counts) <- paste0("cell_", seq_len(ncol(counts)))
  rownames(meta) <- colnames(counts)
}

rownames(counts) <- colnames(expr_df)

dim(counts)  # genes x cells
dim(meta)    # cells x meta data cols

```

Gene x cell matrix = 31,053 genes x 2,702 cells

Cell x meta data matrix = 2,702 cells x 3 meta data cols (cell_id, x, y)



# Create Seurat object for mouse expression data

```{r create-seurat}
mouse_seurat <- CreateSeuratObject(
  counts = counts,
  meta.data = meta,
  min.cells = 3,
  min.features = 200
)

# add mitochondrial percentage
mt_features <- grep(params$mt_prefix, rownames(mouse_seurat), value = TRUE)

if (length(mt_features) > 0) {
  mouse_seurat[["percent.mt"]] <- PercentageFeatureSet(mouse_seurat, features = mt_features)
} else {
  warning(paste0(
    "No mitochondrial genes matched params$mt_prefix = '", params$mt_prefix,
    "'. percent.mt will not be computed."
  ))
}
# add image row/col info for spatial information
mouse_seurat@meta.data$imagerow <- mouse_seurat$y
mouse_seurat@meta.data$imagecol <- mouse_seurat$x

```


# QC plots

```{r qc-plots}
features_to_plot <- c("nFeature_RNA", "nCount_RNA")
if ("percent.mt" %in% colnames(mouse_seurat@meta.data)) features_to_plot <- c(features_to_plot, "percent.mt")

VlnPlot(mouse_seurat, features = features_to_plot, ncol = length(features_to_plot), pt.size = 0.1)
```

nFeature_RNA: Number of detected genes per spot
  - Even spread of genes detected per spot
nCount_RNA: Total UMI (unique molecular identifiers) counts/reads per spot
percent.mt: Percentage of mitochondrial gene expression per spot (if mitochondrial genes were found)
  - Most spots have low mitochondrial percentage (< 20%), indicating good data

```{r}
FeatureScatter(mouse_seurat, "nCount_RNA", "nFeature_RNA")
FeatureScatter(mouse_seurat, "nCount_RNA", "percent.mt")
FeatureScatter(mouse_seurat, "nFeature_RNA", "percent.mt")
```
nCount_RNA vs nFeature_RNA: Positive correlation & tight monotonic relationship (r^2 0.93)
  - spots with higher counts tend to have more detected genes.
nCount_RNA vs percent.mt: No strong correlation (r^2 -0.04)
  - spots with high counts do not necessarily have high mitochondrial percentage
nFeature_RNA vs percent.mt: No strong correlation (r^2 -0.15)
  - spots with more detected genes do not necessarily have high mitochondrial percentage


# Spatial dist of mt percentage
```{r}
# plot spatial distribution of mitochondrial percentage
ggplot(mouse_seurat@meta.data, aes(x = imagecol, y = imagerow, color = percent.mt)) +
  geom_point(size = 0.6) +
  coord_fixed() +
  scale_y_reverse() +
  theme_classic()
```

No strong spatial pattern of mitochondrial percentage across the tissue section, indicating no localized regions of high mitochondrial content

# Filtering 

```{r filtering}
# print filtering params used
if (isTRUE(params$filter)) {
  print(list(
    nFeature_low = params$nFeature_low,
    nFeature_high = params$nFeature_high,
    nCount_high = params$nCount_high,
    percent_mt_high = params$percent_mt_high
  ))

# filter spots based on QC metrics
expr <- mouse_seurat@meta.data$nFeature_RNA >= params$nFeature_low &
        mouse_seurat@meta.data$nFeature_RNA <= params$nFeature_high &
        mouse_seurat@meta.data$nCount_RNA <= params$nCount_high &
        mouse_seurat@meta.data$percent.mt <= params$percent_mt_high

  if ("percent.mt" %in% colnames(mouse_seurat@meta.data)) {
    expr <- expr & (mouse_seurat@meta.data$percent.mt <= params$percent_mt_high)
  }

  mouse_seurat <- subset(mouse_seurat, cells = rownames(mouse_seurat@meta.data)[expr])
}

# Check for NA/NaN/Inf values in count matrix
counts_mat <- GetAssayData(mouse_seurat, assay = "RNA", layer = "counts")

bad <- is.na(counts_mat) | is.infinite(counts_mat)
if (any(bad)) {
  warning("Found NA/Inf in count matrix. Replacing with 0.")
  counts_mat[bad] <- 0
  mouse_seurat <- SetAssayData(mouse_seurat, assay = "RNA", layer = "counts", new.data = counts_mat)
}


# Remove spots with zero total counts 
zero_count_spots <- which(mouse_seurat$nCount_RNA == 0)
if (length(zero_count_spots) > 0) {
  warning(paste("Removing", length(zero_count_spots), "spots with zero total counts"))
  cells_to_keep <- setdiff(colnames(mouse_seurat), names(zero_count_spots))
  mouse_seurat <- subset(mouse_seurat, cells = cells_to_keep)
}

# Filter out low quality spots
# mouse_seurat <- subset(mouse_seurat, subset = nFeature_RNA > 200 & nFeature_RNA < 8000 & percent.mt < 20)

# summary stats for filtering
cat("Data quality summary:\n")
cat("Number of spots:", ncol(mouse_seurat), "\n")
cat("Number of genes:", nrow(mouse_seurat), "\n")
cat("nCount_RNA range:", range(mouse_seurat$nCount_RNA), "\n")
cat("nFeature_RNA range:", range(mouse_seurat$nFeature_RNA), "\n")
cat("Percent MT range:", range(mouse_seurat$percent.mt), "\n")

# variance stabilizing transformation using SCTransform
mouse_seurat_sct <- SCTransform(mouse_seurat,
                          vst.flavor = "v2",
                          variable.features.n = 10000,
                          vars.to.regress = c("percent.mt"),
                          return.only.var.genes = FALSE,
                          verbose = FALSE)

mouse_seurat_sct
```

# nCount_RNA after filtering & SCTransform

```{r}
#  nCount_RNA from counts matrix
counts_mat <- GetAssayData(mouse_seurat_sct, assay = "RNA", layer = "counts")
mouse_seurat_sct$nCount_RNA <- Matrix::colSums(counts_mat)
summary(mouse_seurat_sct$nCount_RNA)
```

Median nCount_RNA spread falls within typical ranges.

# Visualize on x y coords
```{r}
#head(mouse_seurat@meta.data[, c("x","y")])
df <- data.frame(mouse_seurat_sct@meta.data, cluster = Idents(mouse_seurat_sct))
ggplot(df, aes(x = x, y = y)) +
  geom_point(size = 0.8) +
  coord_fixed() +
  scale_y_reverse() +        
  theme_classic() +
  labs(title = "Spots on tissue coordinates", x = "x", y = "y")

```


# look at a specific gene in the tissue coordinates
```{r}
 # list genes
rownames(mouse_seurat_sct)

gene <- "Atf3"  # can change
df$expr <- FetchData(mouse_seurat_sct, vars = gene)[,1]

ggplot(df, aes(x = x, y = y, color = expr)) +
  geom_point(size = 0.8) +
  coord_fixed() +
  scale_y_reverse() +
  theme_classic() +
  labs(title = paste(gene, "expression in tissue coordinates"), x = "x", y = "y")

```


# Dim reduction

```{r seurat-workflow}
# make SCT the default assay for downstream PCA/UMAP
DefaultAssay(mouse_seurat_sct) <- "SCT"
mouse_seurat_PCA <- RunPCA(mouse_seurat_sct, features = VariableFeatures(mouse_seurat_sct))
```


```{r}
#plot elbow plot & PCA 
ElbowPlot(mouse_seurat_PCA)

DimPlot(
  mouse_seurat_PCA,
  reduction = "pca",
  pt.size = 0.6
) + ggtitle("PCA of spatial transcriptomics spots")
```

Elbow plot: PCs 1-10 capture sufficient variance
PCA: Good fanning/crescent shape
  - indicates good separation of spots in PC space

# check for batches
```{r}
#table(mouse_seurat$orig.ident)
#length(unique(mouse_seurat$orig.ident))
head(colnames(mouse_seurat))
length(unique(mouse_seurat$cell_id))
```
No batches found

```{r}
#color PCA by nFeature_RNA, nCount_RNA, percent.mt
FeaturePlot(mouse_seurat_PCA, reduction = "pca", features = c("nFeature_RNA", "nCount_RNA", "percent.mt"))
```

No distinct patterns observed in PCA space for nFeature_RNA, nCount_RNA, or percent.mt
  - indicates these QC metrics are not driving major sources of variation in the data


```{r}
# color PCA by spatial coordinates
FeaturePlot(mouse_seurat_PCA, reduction = "pca", features = c("x", "y"))
```

No distinct patterns observed in PCA space for spatial coordinates x or y
  - indicates spatial location is not driving major sources of variation in the data

```{r}
# genes contributing to PCs
VizDimLoadings(mouse_seurat_PCA, dims = 1:2, reduction = "pca")
```

No obvious highly contributing genes driving PCs 1 or 2

```{r}
# top genes per PC
DimHeatmap(mouse_seurat_PCA, dims = 1:6, cells = 500, balanced = TRUE)
```

# Clustering & UMAP
```{r umap-cluster}
mouse_seurat_PCA <- FindNeighbors(mouse_seurat_PCA, dims = 1:30)
mouse_seurat_PCA <- FindClusters(mouse_seurat_PCA, resolution = params$clustering_resolution)
mouse_seurat_UMAP <- RunUMAP(mouse_seurat_PCA, dims = 1:30)

DimPlot(mouse_seurat_UMAP, reduction = "umap", label = TRUE) + NoLegend()
```


7 identified cell clusters with decent separation in UMAP space

# Clusters on spatial tissue coordinates
```{r}
# plot clusters on spatial tissue coordinates
df <- data.frame(mouse_seurat_UMAP@meta.data, cluster = Idents(mouse_seurat_UMAP))

ggplot(df, aes(x = imagecol, y = imagerow, color = cluster)) +
  geom_point(size = 0.6) +
  coord_fixed() +
  scale_y_reverse() +
  theme_classic() +
  labs(
    title = "UMAP clusters projected onto mouse tissue coordinates",
    x = "image column",
    y = "image row"
  )
```

UMAP clusters have relatively distinct spatial localization patterns on the tissue coordinates.

# Save outputs

```{r save, results='asis'}
out_dir <- "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)

seurat_rds <- file.path(out_dir, "mousebrain_seurat.rds")
saveRDS(mouse_seurat_sct, seurat_rds)

cat("Saved Seurat object to: ", seurat_rds, "\\n")
```

```{r session-info}
sessionInfo()
```