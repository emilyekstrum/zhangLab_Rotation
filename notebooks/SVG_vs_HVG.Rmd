---
title: "SVG_vs_HVG.Rmd"
author: "Emily Ekstrum"
date: '`r Sys.Date()`'
output: html_document

params:
  mouse_seurat_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/seurat_mouse_svg_table.rds"
  mouse_nnSVG_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/nnSVG_mouse_results.rds"
  
  human_seurat_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/seurat_human_svg_table.rds"
  human_nnSVG_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/nnSVG_human_results.rds"
  
  mouse_HVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/mouse_hvg_matrix.rds"
  human_HVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/human_hvg_matrix.rds"
  
  seed: 123
---

# file setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5
)
set.seed(params$seed)
```


# Comapre HVGs and SVGs

# load in packages

```{r packages}
pkgs <- c(
  "Seurat",
  "Matrix",
  "ggplot2",
  "dplyr",
  "tibble",
  "patchwork",
  "Rfast2",
  "BiocManager",
  "tidyverse",
  "UpSetR"
)

to_install <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(to_install) > 0) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

# Load
lapply(pkgs, library, character.only = TRUE)
```

# load in mouse data
```{r}
mouse_svg_seurat <- readRDS(params$mouse_seurat_SVG_path)
mouse_svg_nnSVG <- readRDS(params$mouse_nnSVG_SVG_path)
mouse_hvg <- readRDS(params$mouse_HVG_path)
```

# inspect data frames
```{r}
class(readRDS(params$mouse_nnSVG_SVG_path)) #data.frame
class(readRDS(params$mouse_seurat_SVG_path)) #data.frame
class(readRDS(params$mouse_HVG_path)) #matrix
```

# utils
```{r}
#get gene names from data.frame or matrix
extract_genes_from_df <- function(df, name = "df") {
  stopifnot(is.data.frame(df))
  # get gene names from cols
  candidate_cols <- c("gene", "genes", "feature", "features", "rowname", "rownames", "Gene", "Feature")
  hit <- intersect(candidate_cols, colnames(df))
  if (length(hit) > 0) {
    g <- df[[hit[1]]]
  } else if (!is.null(rownames(df)) && any(nzchar(rownames(df)))) {
    g <- rownames(df)
  } else {
    stop(sprintf(
      "Couldn't find gene identifiers in %s. Add a gene column or rownames(). Colnames are: %s",
      name, paste(colnames(df), collapse = ", ")
    ))
  }
  g <- as.character(g)
  g <- g[!is.na(g) & nzchar(g)]
  unique(g)
}

extract_genes_from_hvg <- function(hvg, name = "hvg") {
  #row names in dgCMatrix
  if (inherits(hvg, "dgCMatrix")) {
    g <- rownames(hvg)
    if (is.null(g) || !any(nzchar(g))) {
      stop(sprintf("%s is dgCMatrix but has no rownames(). Put gene names in rownames.", name))
    }
    return(unique(g))
  }

  # to save HVGs as data.frame
  if (is.character(hvg)) return(unique(hvg))
  if (is.data.frame(hvg)) return(extract_genes_from_df(hvg, name))
  stop(sprintf("Unsupported HVG object type for %s: %s", name, paste(class(hvg), collapse = "/")))
}

#jaccard index
jaccard <- function(a, b) {
  a <- unique(a); b <- unique(b)
  inter <- length(intersect(a, b))
  uni   <- length(union(a, b))
  if (uni == 0) return(NA_real_)
  inter / uni
}
```

# get mouse gene sets
```{r}
mouse_genes_svg_seurat <- extract_genes_from_df(mouse_svg_seurat, "mouse_svg_seurat")
mouse_genes_svg_nnSVG  <- extract_genes_from_df(mouse_svg_nnSVG,  "mouse_svg_nnSVG")
mouse_genes_hvg        <- extract_genes_from_hvg(mouse_hvg,        "mouse_hvg")

mouse_sets <- list(
  Seurat_SVG = mouse_genes_svg_seurat,
  nnSVG      = mouse_genes_svg_nnSVG,
  Seurat_HVG = mouse_genes_hvg
)
```

# jaccard index
```{r}
mouse_pair_names <- combn(names(mouse_sets), 2, simplify = FALSE)

# TODO: limit this to top N genes? 

mouse_jaccard_tbl <- map_dfr(mouse_pair_names, function(p) {
  a <- p[1]; b <- p[2]
  tibble(
    set_a = a,
    set_b = b,
    n_a = length(mouse_sets[[a]]),
    n_b = length(mouse_sets[[b]]),
    n_intersection = length(intersect(mouse_sets[[a]], mouse_sets[[b]])),
    n_union = length(union(mouse_sets[[a]], mouse_sets[[b]])),
    jaccard = jaccard(mouse_sets[[a]], mouse_sets[[b]])
  )
})

print(mouse_jaccard_tbl)
```

The Seurat HVG and SVGs have high agreement based on the Jaccard index. 
nnSVGs had lower yet still high agreement with both Seurat methods. 

```{r}
# 3-way overlap counts 
mouse_overlap_3way <- tibble(
  n_all_three = length(Reduce(intersect, mouse_sets)),
  n_any_two_or_more = sum(table(
    Reduce(c, lapply(names(mouse_sets), function(nm) {
      data.frame(gene = mouse_sets[[nm]], set = nm)
    }))$gene
  ) >= 2) # can remove
)

print(mouse_overlap_3way)
```

8,659 genes overlap between all three variable gene identification methods.

```{r}
# UpSet plot
UpSetR::upset(UpSetR::fromList(mouse_sets),
              order.by = "freq",
              nsets = length(mouse_sets),
              nintersects = NA)
```

8,659 genes overlap between seurat HVG and SVG methods. This drops down to 1,337 between all three methods, and 1,324 genes are unique to nnSVG.4 genes are unique to seurat SVGs.


#---------------- human data -----------------#


# load in human data
```{r}
human_svg_seurat <- readRDS(params$human_seurat_SVG_path)
human_svg_nnSVG <- readRDS(params$human_nnSVG_SVG_path)
human_hvg <- readRDS(params$human_HVG_path)
```

# inspect data frames
```{r}
class(readRDS(params$human_nnSVG_SVG_path)) #data.frame
class(readRDS(params$human_seurat_SVG_path)) #data.frame
class(readRDS(params$human_HVG_path)) #matrix
```

# get human gene sets
```{r}
human_genes_svg_seurat <- extract_genes_from_df(human_svg_seurat, "human_svg_seurat")
human_genes_svg_nnSVG  <- extract_genes_from_df(human_svg_nnSVG,  "human_svg_nnSVG")
human_genes_hvg        <- extract_genes_from_hvg(human_hvg,        "human_hvg")

human_sets <- list(
  Seurat_SVG = human_genes_svg_seurat,
  nnSVG      = human_genes_svg_nnSVG,
  Seurat_HVG = human_genes_hvg
)
```

# jaccard index for human genes
```{r}
human_pair_names <- combn(names(human_sets), 2, simplify = FALSE)

human_jaccard_tbl <- map_dfr(human_pair_names, function(p) {
  a <- p[1]; b <- p[2]
  tibble(
    set_a = a,
    set_b = b,
    n_a = length(human_sets[[a]]),
    n_b = length(human_sets[[b]]),
    n_intersection = length(intersect(human_sets[[a]], human_sets[[b]])),
    n_union = length(union(human_sets[[a]], human_sets[[b]])),
    jaccard = jaccard(human_sets[[a]], human_sets[[b]])
  )
})

print(human_jaccard_tbl)
```

The Seurat HVG and SVGs have high agreement based on the Jaccard index. 
Similar to the mouse dataset, nnSVGs had lower agreement with both Seurat methods. 

```{r}
# 3-way overlap counts 
human_overlap_3way <- tibble(
  n_all_three = length(Reduce(intersect, human_sets)),
  n_any_two_or_more = sum(table(
    Reduce(c, lapply(names(human_sets), function(nm) {
      data.frame(gene = human_sets[[nm]], set = nm)
    }))$gene
  ) >= 2) # can remove
)

print(human_overlap_3way)
```

4,985 genes overlap between all three variable gene identification methods. This number is around the mouse overlap for all three methods (4,258).

```{r}
# UpSet plot
UpSetR::upset(UpSetR::fromList(human_sets),
              order.by = "freq",
              nsets = length(human_sets),
              nintersects = NA)
```

4,985 genes overlap between all three methods. 5,015 genes are common between Seurat HVGs and SVGs, and 2 genes are unique to nnSVG. 