---
title: "nnSVG_SVGs"
author: "Emily Ekstrum"
date: "`r Sys.Date()`"
output: html_document

params:
  mouse_rds_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/seurat_objs/mousebrain_seurat.rds"
  human_rds_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/seurat_objs/humanbrain_seurat.rds"
  seed: 123

---


```{r}
# set up to limit threads for BLAS/LAPACK operations
## Must be set before loading Matrix / nnSVG / BRISC / Seurat
Sys.setenv(
  OMP_NUM_THREADS = "1",
  OPENBLAS_NUM_THREADS = "1",
  MKL_NUM_THREADS = "1",
  VECLIB_MAXIMUM_THREADS = "1",
  NUMEXPR_NUM_THREADS = "1"
)

#  helps (limits BLAS threads if you have RhpcBLASctl)
if (requireNamespace("RhpcBLASctl", quietly = TRUE)) {
  RhpcBLASctl::blas_set_num_threads(1)
  RhpcBLASctl::omp_set_num_threads(1)
}

```

```{r}
library(BiocParallel)
library(nnSVG)

bp <- SnowParam(workers = 3, type = "SOCK")  # parallel on macOS
# or for max stability:
# bp <- SerialParam()
```


# -------------- mouse data ------------------ # 

```{r}
# load in mouse seurat object
mouse_seurat <- readRDS(params$mouse_rds_path)
```

```{r}
library(Seurat)
library(Matrix)
library(BRISC)

# extract expression as a real sparse matrix
mouse_exp_mat <- LayerData(mouse_seurat, assay = "RNA", layer = "counts")

# force dgCMatrix 
mouse_exp_mat <- as(mouse_exp_mat, "dgCMatrix")

# coords with rownames = cell barcodes
mouse_coords <- mouse_seurat@meta.data[, c("imagecol", "imagerow"), drop = FALSE]
stopifnot(!is.null(rownames(mouse_coords)))
mouse_coords <- as.matrix(mouse_coords)
storage.mode(mouse_coords) <- "double"

# align cells
mouse_common <- intersect(colnames(mouse_exp_mat), rownames(mouse_coords))
stopifnot(length(mouse_common) > 0)
mouse_exp_mat <- mouse_exp_mat[, mouse_common, drop = FALSE]
mouse_coords <- mouse_coords[mouse_common, , drop = FALSE]

# keep genes that are expressed in at least 10 spots
mouse_keep <- Matrix::rowSums(mouse_exp_mat > 0) >= 10  # can edit to make more strict
mouse_exp_mat <- mouse_exp_mat[mouse_keep, , drop = FALSE]

# cap to 3000 most variable genes using sparse variance proxy - NOT USED AS OF 1/16/26
# mouse_gene_vars <- Matrix::rowMeans(mouse_exp_mat^2) - (Matrix::rowMeans(mouse_exp_mat))^2
# mouse_top <- names(sort(mouse_gene_vars, decreasing = TRUE))[1:min(10000, length(mouse_gene_vars))]
# mouse_exp_mat <- mouse_exp_mat[mouse_top, , drop = FALSE]

# check you have dgCMatrix
#class(mouse_exp_mat)
#is(mouse_exp_mat, "dgCMatrix")

```

```{r}
# run nnSVG to find spatially variable genes
mouse_svgs <- nnSVG(input = mouse_exp_mat, spatial_coords = mouse_coords, BPPARAM = bp)
```

```{r}
library(tidyverse)

# create svg dataframe
mouse_svgs <- as.data.frame(mouse_svgs)

# subset the genes where padj < 0.05
mouse_auto_genes_list <- mouse_svgs %>%
  filter(padj < 0.1) %>%
  rownames()

head(mouse_auto_genes_list)
head(mouse_svgs) # LR stat is log likelihood ratio
length(rownames(mouse_svgs)) # 5000 genes
```

```{r}
# create results data frame
mouse_res <- as.data.frame(mouse_svgs)
mouse_res$gene <- rownames(mouse_res)

# print rows of mouse_res
length(rownames(mouse_res))

# remove MT genes with grep
mouse_res <- mouse_res[!grepl("^MT-|^mt-", mouse_res$gene), ]
length(rownames(mouse_res))

# remove blood genes
mouse_res <- mouse_res[!mouse_res$gene %in% c("Hba-a1", "Hba-a2", "Hbb-bs", "Hbb-bt"), ]
length(rownames(mouse_res)) # 4984 genes

# keep finite padj
mouse_res <- mouse_res[is.finite(mouse_res$padj) & !is.na(mouse_res$padj), ]
mouse_res$neglog10_padj <- -log10(pmax(mouse_res$padj, 1e-300))

# look at top results
head(mouse_res[, c("gene","LR_stat","pval","padj","rank")])

```

```{r}
# sort by rank column
mouse_res <- mouse_res[order(mouse_res$rank), ]
head(mouse_res)

# save res data frame
saveRDS(mouse_res, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_mouse_results.rds")
```

# store SVGs in a gene by cell matrix
```{r human-svg-matrix}
mouse_svg_matrix <- GetAssayData(mouse_seurat, assay = "SCT", layer = "data")[mouse_res$gene, ]
mouse_svg_matrix[1:5, 1:5]
head(rownames(mouse_svg_matrix), 20)
```

# save mouse SVG matrix
```{r save-svg-matrix}
saveRDS(mouse_svg_matrix, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_mouse_svg_gene_cell_matrix.rds")
```

# or store SVGs in a cell by gene matrix
```{r}
mouse_svg_matrix <- t(mouse_svg_matrix)
mouse_svg_matrix[1:5, 1:5]
head(colnames(mouse_svg_matrix), 20)
```

# save mouse SVG matrix
```{r save-mouse-svg-matrix}
saveRDS(mouse_svg_matrix, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_mouse_svg_cell_gene_matrix.rds")
```

```{r}
# volcano plot: rank vs -log10(padj)
ggplot(mouse_res, aes(x = rank, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "Rank (1 = most significant)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# volcano plot: log likelihood vs -log10(padj)
ggplot(mouse_res, aes(x = LR_stat, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "LR_stat",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# p value dist
ggplot(mouse_res, aes(x = padj)) +
  geom_histogram(bins = 50) +
  labs(title = "Adjusted p-value distribution", x = "padj", y = "Count") +
  theme_classic()

```

```{r}
# pick top genes by padj
top_n <- 6
mouse_top_genes <- head(mouse_res$gene[order(mouse_res$padj)], top_n)

#filter out MT genes and get top genes again
mouse_top_genes <- mouse_res %>%
  filter(!grepl("^MT-|mt-", gene)) %>%
  arrange(padj) %>%
  slice_head(n = top_n) %>%
  pull(gene)

# coords with barcodes as rownames
mouse_coords <- mouse_seurat@meta.data[, c("imagecol","imagerow"), drop = FALSE]
mouse_coords$cell <- rownames(mouse_coords)

# helper to plot one gene
plot_svg_gene <- function(g) {
  if (!g %in% rownames(mouse_exp_mat)) stop(paste("Gene not found in matrix:", g))
  df <- mouse_coords
  df$expr <- as.numeric(mouse_exp_mat[g, df$cell])

  ggplot(df, aes(x = imagecol, y = imagerow, color = expr)) +
    geom_point(size = 0.8) +
    scale_y_reverse() +    
    xlab("x") +
    ylab("y") +
    coord_equal() +
    labs(title = g, color = "Expr") +
    theme_classic()
}

plots <- lapply(mouse_top_genes, plot_svg_gene)
wrap_plots(plots, ncol = 3)

```

```{r}
# scatter plot: prop_sv vs -log10(padj)
ggplot(mouse_res, aes(x = prop_sv, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  labs(title = "prop_sv vs significance", x = "prop_sv", y = "-log10(padj)") +
  theme_classic()

```

# heatmap of top 50 SVGs using DoHeatmap()
```{r}
top50_genes <- mouse_res %>% 
  arrange(padj) %>%
  slice_head(n = 50) %>%
  pull(gene) 
DoHeatmap(mouse_seurat, features = top50_genes) + 
  labs(title = "Top 50 nnSVG genes heatmap") 
```


# plot heatmap by clusters - first need to generate clusters
```{r}
options(future.globals.maxSize = 8 * 1024^3)
library(future)
plan(multisession)  # or sequential

DefaultAssay(mouse_seurat) <- "SCT"

mouse_seurat <- Seurat::RunPCA(mouse_seurat, verbose = FALSE)
mouse_seurat <- Seurat::FindNeighbors(mouse_seurat, reduction = "pca", dims = 1:30, verbose = FALSE)

# check graph exists right before clustering
names(mouse_seurat@graphs)

mouse_seurat <- Seurat::FindClusters(mouse_seurat, graph.name = "SCT_snn", resolution = 0.5, verbose = FALSE)
```

```{r}
# view cluster identities
table(Idents(mouse_seurat))
colnames(mouse_seurat@meta.data)
```

# Heatmap of top 50 SVGs by clusters
```{r}
DoHeatmap(
  mouse_seurat,
  features = top50_genes,
  group.by = "seurat_clusters",
  size = 3
) + NoLegend()
```

There is evidence of cluster-specific expression patterns for some of the top SVGs.
Cluster 0 is defined by high expression of Fth1, Mbp, Plp1, Mobp, Apod, and Td.
  - slight blood contamination evidence, but other genes associated with myelin
Cluster 1 is weakly associated with high expression of Pcsk1n, Nrgn, and Cpe.
  - neurotransmitter related genes
Cluster 2 is defined by high expression of Snap25, pcp2, and Pvalp.
  - neurotransmitter related genes for motor activity and cognitive function
Cluster 3 is defined by high expression of Snap25, Pvalp, Gnas, Atp1b1, Rps29, and Ndufa4.
  - protein synthesis related genes - not sure what to make of this?
Cluster 4 is strongly associated with high expression of Pcb4, Ckb, Pvalp, Gapdh, and Gng13.
  - regulate ATP in the brain and signaling
Cluster 5 is defined by high expression of Ptgds, Cpe, and Nrgn.
  - enzymatic brain functions
Cluster 6 has high expression of Pcp4, Snap25, Cpe, and Calm1.
  - neurotransmitter and calcium binding
Cluster 7 has high expression of Nrgn, Calm2, and Calm1.
  - neurotransmitter and calcium binding

# -------------- human data ------------------ # 

```{r}
human_seurat <- readRDS(params$human_rds_path)
```

```{r}
# extract expression as a real sparse matrix
human_exp_mat <- LayerData(human_seurat, assay = "RNA", layer = "counts")

# force dgCMatrix 
human_exp_mat <- as(human_exp_mat, "dgCMatrix")

# coords with rownames = cell barcodes
human_coords <- human_seurat@meta.data[, c("imagecol", "imagerow"), drop = FALSE]
stopifnot(!is.null(rownames(human_coords)))
human_coords <- as.matrix(human_coords)
storage.mode(human_coords) <- "double"

# align cells
human_common <- intersect(colnames(human_exp_mat), rownames(human_coords))
stopifnot(length(human_common) > 0)
human_exp_mat <- human_exp_mat[, human_common, drop = FALSE]
human_coords <- human_coords[human_common, , drop = FALSE]

# keep genes that are expressed in at least 10 spots
human_keep <- Matrix::rowSums(human_exp_mat > 0) >= 10  # can edit to make more strict
human_exp_mat <- human_exp_mat[human_keep, , drop = FALSE]

# cap to 3000 most variable genes using sparse variance proxy - NOT USED AS OF 1/16/26
# human_gene_vars <- Matrix::rowMeans(human_exp_mat^2) - (Matrix::rowMeans(human_exp_mat))^2
# human_top <- names(sort(human_gene_vars, decreasing = TRUE))[1:min(5000, length(human_gene_vars))]
# human_exp_mat <- human_exp_mat[human_top, , drop = FALSE]

# check you have dgCMatrix
#class(human_exp_mat)
#is(human_exp_mat, "dgCMatrix")

```

```{r}
# run nnSVG to find spatially variable genes
human_svgs <- nnSVG(input = human_exp_mat, spatial_coords = human_coords, BPPARAM = bp)
```

```{r}
library(tidyverse)

# create svg dataframe
human_svgs <- as.data.frame(human_svgs)

# subset the genes where padj < 0.05
human_auto_genes_list <- human_svgs %>%
  filter(padj < 0.1) %>%
  rownames()

head(human_auto_genes_list)
head(human_svgs) # LR stat is log likelihood ratio
```

```{r}
# create results data frame
human_res <- as.data.frame(human_svgs)
human_res$gene <- rownames(human_res)

# remove MT genes with grep
human_res <- human_res[!grepl("^MT-|^mt-", human_res$gene), ]
length(rownames(human_res))

# remove blood genes
human_res <- human_res[!human_res$gene %in% c("Hba-a1", "Hba-a2", "Hbb-bs", "Hbb-bt"), ]
length(rownames(human_res))

# keep finite padj
human_res <- human_res[is.finite(human_res$padj) & !is.na(human_res$padj), ]
human_res$neglog10_padj <- -log10(pmax(human_res$padj, 1e-300))

# print rows of human_res
length(rownames(human_res))

# look at top results
# TODO: filter out MT genes?
head(human_res[, c("gene","LR_stat","pval","padj","rank")])
```

```{r}
# sort by rank column
human_res <- arrange(human_res, rank)
head(human_res)

# save res data frame
saveRDS(human_res, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_human_results.rds")
```

# store SVGs in a gene by cell matrix
```{r human-svg-matrix}
human_svg_matrix <- GetAssayData(human_seurat, assay = "SCT", layer = "data")[human_res$gene, ]
human_svg_matrix[1:5, 1:5]
head(rownames(human_svg_matrix), 20)
```

# save mouse SVG matrix
```{r save-human-svg-matrix}
saveRDS(human_svg_matrix, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_human_svg_gene_cell_matrix.rds")
```

# or store SVGs in a cell by gene matrix
```{r}
human_svg_matrix <- t(human_svg_matrix)
human_svg_matrix[1:5, 1:5]
head(colnames(human_svg_matrix), 20)
```

# save mouse SVG matrix
```{r save-human-svg-matrix}
saveRDS(human_svg_matrix, file = "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/svgs/nnSVG_human_svg_cell_gene_matrix.rds")
```

```{r}
# volcano plot: rank vs -log10(padj)
ggplot(human_res, aes(x = rank, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "Rank (1 = most significant)",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# volcano plot: log likelihood vs -log10(padj)
ggplot(human_res, aes(x = LR_stat, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "nnSVG results",
    x = "LR_stat",
    y = "-log10(adjusted p-value)"
  ) +
  theme_classic()

```

```{r}
# p value dist
ggplot(human_res, aes(x = padj)) +
  geom_histogram(bins = 50) +
  labs(title = "Adjusted p-value distribution", x = "padj", y = "Count") +
  theme_classic()

```

```{r}
library(Seurat)
library(Matrix)
library(patchwork)

# pick top genes by padj
human_top_n <- 6
human_top_genes <- head(human_res$gene[order(human_res$padj)], human_top_n)

#filter out MT genes and get top genes again
human_top_genes <- human_res %>%
  filter(!grepl("^MT-", gene)) %>%
  arrange(padj) %>%
  slice_head(n = human_top_n) %>%
  pull(gene)

# coords with barcodes as rownames
human_coords <- human_seurat@meta.data[, c("imagecol","imagerow"), drop = FALSE]
human_coords$cell <- rownames(human_coords)

# helper to plot one gene
plot_svg_gene <- function(g) {
  if (!g %in% rownames(human_exp_mat)) stop(paste("Gene not found in matrix:", g))
  df <- human_coords
  df$expr <- as.numeric(human_exp_mat[g, df$cell])

  ggplot(df, aes(x = imagecol, y = imagerow, color = expr)) +
    geom_point(size = 0.8) +
    scale_y_reverse() +
    xlab("x") +
    ylab("y") +
    coord_equal() +
    labs(title = g, color = "Expr") +
    theme_classic()
}

plots <- lapply(human_top_genes, plot_svg_gene)
wrap_plots(plots, ncol = 3)

```

```{r}
# scatter plot: prop_sv vs -log10(padj)
ggplot(human_res, aes(x = prop_sv, y = neglog10_padj)) +
  geom_point(size = 1, alpha = 0.7) +
  labs(title = "prop_sv vs significance", x = "prop_sv", y = "-log10(padj)") +
  theme_classic()

```

# heatmap of top 50 SVGs using DoHeatmap()
```{r}
top50_genes <- human_res %>% 
  arrange(padj) %>%
  slice_head(n = 50) %>%
  pull(gene) 
DoHeatmap(human_seurat, features = top50_genes) + 
  labs(title = "Top 50 nnSVG genes heatmap") 
```

# plot heatmap by clusters - first need to generate clusters
```{r}
options(future.globals.maxSize = 8 * 1024^3)
library(future)
plan(multisession)  # or sequential

DefaultAssay(human_seurat) <- "SCT"

human_seurat <- Seurat::RunPCA(human_seurat, verbose = FALSE)
human_seurat <- Seurat::FindNeighbors(human_seurat, reduction = "pca", dims = 1:30, verbose = FALSE)

# check graph exists right before clustering
names(human_seurat@graphs)

human_seurat <- Seurat::FindClusters(human_seurat, graph.name = "SCT_snn", resolution = 0.5, verbose = FALSE)
```

```{r}
# view cluster identities
table(Idents(human_seurat))
colnames(human_seurat@meta.data)
```


# Heatmap of top 50 SVGs by clusters
```{r}
DoHeatmap(
  human_seurat,
  features = top50_genes,
  group.by = "seurat_clusters",
  size = 3
) + NoLegend()
```

Weak evidence of cluster-specific expression patterns for some of the top SVGs.
Cluster 3 is defined by high expression of Mbp, Plp1, Ftr1, Gfap, Crayb, Tpgds, and Cnp.
  - myelin and glial associated genes
Cluster 4 has high expression of Scgb2a2.
  - secretoglobin family gene

The other clusters have less clear expression patterns.

