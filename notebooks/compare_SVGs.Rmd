---
title: "compare_SVGs"
author: "Emily Ekstrum"
date: "`r Sys.Date()`"
output: html_document

params:
  mouse_seurat_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/seurat_mouse_svg_table.rds"
  mouse_nnSVG_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/nnSVG_mouse_results.rds"
  
  human_seurat_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/seurat_human_svg_table.rds"
  human_nnSVG_SVG_path: "/Users/emilyekstrum/repos/zhangLab_Rotation/data/processed/nnSVG_human_results.rds"
  seed: 123
---

# file setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 8,
  fig.height = 5
)
set.seed(params$seed)
```


# Comapre SVGs identified using FindSpatiallyVariableGenes() (seurat) vs nnSVG() 

# load in packages

```{r packages}
pkgs <- c(
  "Seurat",
  "Matrix",
  "ggplot2",
  "dplyr",
  "tibble",
  "patchwork",
  "Rfast2",
  "STew",
  "BiocManager"
)

to_install <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(to_install) > 0) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

# Load
lapply(pkgs, library, character.only = TRUE)
```

# --------------- mouse data ----------------- #

# load in mouse data
```{r}
mouse_svg_seurat <- readRDS(params$mouse_seurat_SVG_path)
mouse_svg_nnSVG <- readRDS(params$mouse_nnSVG_SVG_path)
```

# inspect data frames
```{r}
class(readRDS(params$mouse_nnSVG_SVG_path)) #data.frame
dim(mouse_svg_seurat) # 10,000 genes x 3
head(rownames(mouse_svg_nnSVG)) # genes
head(colnames(mouse_svg_nnSVG), length(colnames(mouse_svg_nnSVG))) # stats

class(readRDS(params$mouse_seurat_SVG_path)) #data.frame
dim(mouse_svg_seurat) # 10,000 genes x 3
head(rownames(mouse_svg_seurat)) # genes
head(colnames(mouse_svg_seurat), length(colnames(mouse_svg_seurat))) # stats
```



# compare top 1000 SVGs overlap
```{r}
top_n <- 1000
mouse_seurat_genes <- rownames(mouse_svg_seurat)[1:top_n]
mouse_nnSVG_genes <- rownames(mouse_svg_nnSVG)[1:top_n]
mouse_common_genes <- intersect(mouse_seurat_genes, mouse_nnSVG_genes)
length(mouse_common_genes) # 333 common genes
```

# gene overlap by significance
```{r}
# nnSVG results
nn_df <- as.data.frame(readRDS(params$mouse_nnSVG_SVG_path))
nn_df$gene <- rownames(nn_df)

# Seurat SVG results
seu_df <- as.data.frame(readRDS(params$mouse_seurat_SVG_path))
seu_df$gene <- rownames(seu_df)

# nnSVG p-values
nn_pcol <- if ("padj" %in% names(nn_df)) "padj" else "pval"

# Seurat p-values
seu_pcol <- "p.value"

# rank by significance
nn_ranked <- nn_df[order(nn_df[[nn_pcol]]), c("gene", nn_pcol)]
seu_ranked <- seu_df[order(seu_df[[seu_pcol]]), c("gene", seu_pcol)]

topN <- 500

nn_top  <- nn_ranked$gene[1:topN]
seu_top <- seu_ranked$gene[1:topN]

# overlap size
length(intersect(nn_top, seu_top))

# overlapping genes
common_svg_genes <- intersect(nn_top, seu_top)
head(common_svg_genes, 20) # 163 overlapping genes in top 500
```

# jaccard index
```{r}
jaccard <- length(common_svg_genes) / length(union(nn_top, seu_top))
jaccard # 0.1947
```

# correlation of shared genes
```{r}
shared <- intersect(nn_ranked$gene, seu_ranked$gene)

nn_rank_vec  <- match(shared, nn_ranked$gene)
seu_rank_vec <- match(shared, seu_ranked$gene)

cor(nn_rank_vec, seu_rank_vec, method = "spearman", use = "complete.obs") # 0.5547
```

# look at gene disagreements
```{r}
# genes nnSVG called significant but Seurat did not
setdiff(nn_top, seu_top)[1:20]
```

```{r}
# genes Seurat called significant but nnSVG did not
setdiff(seu_top, nn_top)[1:20]
```

# ------------------- human data ------------------ #

# load in human data
```{r}
human_svg_seurat <- readRDS(params$human_seurat_SVG_path)
human_svg_nnSVG <- readRDS(params$human_nnSVG_SVG_path)
```

# inspect data frames
```{r}
class(readRDS(params$human_nnSVG_SVG_path)) #data.frame
dim(human_svg_seurat) # 10,000 genes x 3
head(rownames(human_svg_nnSVG)) # genes
head(colnames(human_svg_nnSVG), length(colnames(human_svg_nnSVG))) # stats

class(readRDS(params$human_seurat_SVG_path)) #data.frame
dim(human_svg_seurat) # 10,000 genes x 3
head(rownames(human_svg_seurat)) # genes
head(colnames(human_svg_seurat), length(colnames(human_svg_seurat))) # stats
```



# compare top 1000 SVGs overlap
```{r}
top_n <- 1000
human_seurat_genes <- rownames(human_svg_seurat)[1:top_n]
human_nnSVG_genes <- rownames(human_svg_nnSVG)[1:top_n]
human_common_genes <- intersect(human_seurat_genes, human_nnSVG_genes)
length(human_common_genes) # 269 common genes
```

# gene overlap by significance
```{r}
# nnSVG results
nn_df <- as.data.frame(readRDS(params$human_nnSVG_SVG_path))
nn_df$gene <- rownames(nn_df)

# Seurat SVG results
seu_df <- as.data.frame(readRDS(params$human_seurat_SVG_path))
seu_df$gene <- rownames(seu_df)

# nnSVG p-values
nn_pcol <- if ("padj" %in% names(nn_df)) "padj" else "pval"

# Seurat p-values
seu_pcol <- "p.value"

# rank by significance
nn_ranked <- nn_df[order(nn_df[[nn_pcol]]), c("gene", nn_pcol)]
seu_ranked <- seu_df[order(seu_df[[seu_pcol]]), c("gene", seu_pcol)]

topN <- 500

nn_top  <- nn_ranked$gene[1:topN]
seu_top <- seu_ranked$gene[1:topN]

# overlap size
length(intersect(nn_top, seu_top))

# overlapping genes
common_svg_genes <- intersect(nn_top, seu_top)
head(common_svg_genes, 20) # 131 overlapping genes in top 500
```

# jaccard index
```{r}
jaccard <- length(common_svg_genes) / length(union(nn_top, seu_top))
jaccard # 0.1507
```

# correlation of shared genes
```{r}
shared <- intersect(nn_ranked$gene, seu_ranked$gene)

nn_rank_vec  <- match(shared, nn_ranked$gene)
seu_rank_vec <- match(shared, seu_ranked$gene)

cor(nn_rank_vec, seu_rank_vec, method = "spearman", use = "complete.obs") # 0.5122
```

# look at gene disagreements
```{r}
# genes nnSVG called significant but Seurat did not
setdiff(nn_top, seu_top)[1:20]
```

```{r}
# genes Seurat called significant but nnSVG did not
setdiff(seu_top, nn_top)[1:20]
```